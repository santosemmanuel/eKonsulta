<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>MHO Burauen Registration</title>
        <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}"
              rel="stylesheet">
        <style>
:root {
    --green: #28a745;
    --yellow-dark: #FFD500;
    --light-yellow: #e9f5ed;
    --border: #ced4da;
}

body {
    background: #f8f9fa;
    font-family: Inter, sans-serif;
}

.form-card {
    background: #fff;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.05);
}

.section-header {
    background: linear-gradient(to left, #FFD500, var(--green));
    color: #f4f4f4;
    padding: 12px 20px;
    margin: -20px -20px 20px -20px;
    border-radius: 16px 16px 0 0;
    font-weight: 700;
}

.form-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 2px;
}

.form-control, .form-select {
    height: 38px;
    font-size: 0.85rem;
    border-radius: 8px;
}

.toggle-box {
    display: flex;
    gap: 10px;
    width: 100%;
}

.toggle-box label {
    flex: 1;                 /* makes all toggles equally wide */
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
}

/* hide input */
.toggle-box input {
    display: none;
}

/* span fills the whole label */
.toggle-box span {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px;
    width: 100%;
    height: 100%;
    border-radius: 8px;
    transition: all 0.2s ease;
}

/* active state */
.toggle-box input:checked + span {
    background: #28a745;
    color: #f4f4f4;
    font-weight: 700;
}



.btn-submit {
    background: var(--green);
    color: #f4f4f4;
    font-weight: 600;
    border-radius: 8px;
}

.btn-submit:hover {
    background: #218838;
    color: #f4f4f4;
}

.app-header {
                background: linear-gradient(to left, #FFD500, var(--green));
                color: #f4f4f4;
                padding: 15px 30px;
                border-radius: 12px;
                margin-bottom: 25px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .app-header h1 {
                font-size: 1.6rem;
                font-weight: 700;
                margin-bottom: 0;
            }
            .app-header .subtitle {
                font-size: 0.95rem;
                opacity: 0.9;
                margin-top: 5px;
            }
            .mho-logo {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                object-fit: cover;
                margin-right: 15px;
            }
             .app-header .header-icon-right {
                font-size: 2rem;
                color: rgba(255, 255, 255, 0.8);
             }
        </style>
    </head>
    <body>
        <div class="container py-4" style="max-width: 900px;">
            <div class="app-header">
                <div class="d-flex align-items-center">
                    <img src="{{ url_for('static', filename='img/MHO_Logo.jpg') }}"
                         alt="MHO Burauen Logo Placeholder"
                         class="mho-logo" />
                    <div>
                        <h1 class="mb-0">eKonsultaForms</h1>
                        <div class="subtitle">Electronic Konsulta Forms Processing System</div>
                    </div>
                </div>
                <i class="fa-solid fa-dog header-icon-right"></i>
            </div>
            <div class="form-card">
                <div class="section-header">MHO Burauen – Patient Registration</div>
                <form id="philhealthForm">
                    <!-- OPTION -->
                    <label class="form-label fw-bold">Option</label>
                    <div class="toggle-box mb-3">
                        <label>
                            <input type="radio" name="option" checked>
                            <span>Member</span>
                        </label>
                        <label>
                            <input type="radio" name="option">
                            <span>Dependent</span>
                        </label>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Member's PIN</label>
                            <input type="text" class="form-control">
                        </div>
                        <div id="DependentPIN" class="col-md-4 d-none">
                            <label class="form-label" id="DependentPINText">Dependent's PIN</label>
                            <input type="text" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Date Today</label>
                            <input type="date" class="form-control" value="<?= date('Y-m-d') ?>">
                        </div>
                    </div>
                    <hr>
                    <!-- FULL NAME -->
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Middle Name</label>
                            <input type="text" class="form-control">
                        </div>
                        <div class="col-md-1">
                            <label class="form-label">Ext</label>
                            <input type="text" class="form-control">
                        </div>
                    </div>
                    <hr>
                    <!-- ADDRESS -->
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label">Municipality</label>
                            <select class="form-select" id="municipality" name="municipality" required>
                                <option value="">Choose Municipality...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Barangay</label>
                            <select class="form-select" name="barangay" id="barangay" required>
                                <option value="">Choose barangay...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Province</label>
                            <input type="text" class="form-control" value="LEYTE">
                        </div>
                    </div>
                    <hr>
                    <!-- OTHER DETAILS -->
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="form-label">Date of Birth</label>
                            <input type="date" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Contact Number</label>
                            <input type="text" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Gender</label>
                            <select class="form-select">
                                <option value="">Select</option>
                                <option>Male</option>
                                <option>Female</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-submit w-100 mt-4 py-3">SUBMIT</button>
                </form>
            </div>
        </div>
        <script>
            const toggleBoxes = document.querySelectorAll('.toggle-box input');
            const dependentPINDiv = document.getElementById('DependentPIN');
            toggleBoxes.forEach(box => {
                box.addEventListener("change", function() {
                    dependentPINDiv.classList.toggle('d-none');
                })
            });
        </script>
        <script>
            let leyteData = {};
            let leyteBrgy = {};

            fetch("{{ url_for('static', filename='data/municipalities.json') }}")
                .then(response => response.json())
                .then(data => {
                    leyteData = data;
                    populateMunicipalities();
                })
                .catch(error => console.error("Error loading JSON:",error))

            fetch("{{ url_for('static', filename='data/barangays.json') }}")
                .then(response => response.json())
                .then(data => {
                    leyteBrgy = data;
                })
                .catch(error => console.error("Error loading JSON:",error))
            
            function populateMunicipalities(){
                const municipalitySelect = document.getElementById("municipality");

                for(let iteration in leyteData){
                    const option = document.createElement('option');
                    option.value = leyteData[iteration].name
                    option.text = leyteData[iteration].name
                    municipalitySelect.appendChild(option);
                }
      
            }

            document.getElementById('municipality').addEventListener("change", function () {
                const barangaySelect = document.getElementById("barangay");
                barangaySelect.innerHTML = '<option value="">-- Select Barangay --</option>';
                const selectedMunicipality = this.value;
                const filterBrgy = leyteBrgy.filter(
                    item => item.citymun === selectedMunicipality
                )

                filterBrgy.forEach( brgy => {
                    const option = document.createElement("option");
                    option.value = brgy.name
                    option.text = brgy.name
                    barangaySelect.appendChild(option)
                })

            })

            const form = document.getElementById('philhealthForm')

            form.addEventListener('submit', async function (event) {
                // Prevent default submission behavior
                event.preventDefault()
                event.stopPropagation()

                // // Check if the form is valid according to HTML5/Bootstrap validation
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return; // Stop if validation fails
                }
                
                // // --- Form is valid, proceed with data collection and submission ---

                const patientIsMemberValue = document.querySelector('input[name="patientIsMember"]:checked').value;

                const data = {
                    pin: form.pin.value,
                    lastName: form.lastName.value,
                    firstName: form.firstName.value,
                    nameExt: form.nameExt.value,
                    middleName: form.middleName.value,
                    dob: form.dob.value,
                    sex: form.sex.value,
                    street: form.street.value,
                    barangay: form.barangay.value,
                    municipality: form.municipality.value,
                    mobile: form.mobile.value,
                    email: form.email.value,
                    patientIsMember: patientIsMemberValue,
                    dependent: patientIsMemberValue === "no" ? {
                        depPin: form.depPin.value,
                        depLname: form.depLname.value,
                        depFname: form.depFname.value,
                        depMname: form.depMname.value,
                        depDob: form.depDob.value,
                        depSex: form.depSex.value,
                        depExt: form.depExt.value,
                        relationship: form.relationship.value
                    } : null,
                    signee: form.signee.value,
                    representative: form.signee.value === "representative" ? {
                        repName: form.repName.value,
                        repRelationship: form.repRelationship.value,
                        repReason: form.repReason.value
                    } : null,
                    patientDisposition: form.querySelector("select[name='patientDisposition']")?.value || ""
                };
                
                // // ** NEW SUBMISSION VIA FETCH API TO /submit_form **
                // try {
                //     console.log("Attempting to submit data to /submit_form:", data);
                    
                //     const response = await fetch('/submit_form', {
                //         method: 'POST',
                //         headers: {
                //             'Content-Type': 'application/json'
                //         },
                //         // Convert the JavaScript object to a JSON string
                //         body: JSON.stringify(data)
                //     });

                //     if (response.ok) {
                //         // Submission was successful (e.g., status 200-299)
                //         alert("✅ MHO Burauen Form submitted successfully!");
                //         window.location.href = '/view_print';
                //         form.reset(); // Clear the form fields
                //         form.classList.remove('was-validated'); // Remove validation state
                //     } else {
                //         // Submission failed on the server side (e.g., status 400 or 500)
                //         const errorText = await response.text();
                //         console.error("Submission failed:", errorText);
                //         alert(`⚠️ Submission failed. Server responded with status: ${response.status}`);
                //     }
                // } catch (error) {
                //     // Network error (e.g., server offline)
                //     console.error("Network or unexpected error during submission:", error);
                //     alert("❌ An error occurred. Could not connect to the submission server.");
                // }
                console.log("Test");
            });
                
        </script>
    </body>
</html>
